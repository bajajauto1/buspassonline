<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bajaj Auto - Bus Pass Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .page { display: none; transition: all 0.3s ease; }
    .page.active { display: block; }
    
    /* PRESERVED PASS FORMATTING */
    .pass-label { font-weight: 600; }
    .pass-value { margin-left: 6px; }
    .pass-border { border: 3px dotted #000; padding: 15px; background: white; width: 100%; max-width: 350px; margin: 0 auto; }
    
    /* Modern UI Elements */
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .nav-btn.active { border-bottom: 3px solid #1d4ed8; color: #1d4ed8; font-weight: bold; }
    input { transition: all 0.2s; border: 1px solid #e2e8f0; }
    input:focus { border-color: #3b82f6; ring: 2px; ring-color: #bfdbfe; outline: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

  <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex flex-col items-center">
      <h1 class="text-lg md:text-xl font-bold tracking-tight">BAJAJ AUTO CHAKAN-1</h1>
      <p class="text-xs text-blue-200 uppercase tracking-widest">Bus Pass Management System</p>
    </div>
  </header>

  <nav class="bg-white border-b sticky top-[68px] z-40 shadow-sm">
    <div class="flex justify-center max-w-md mx-auto">
      <button id="navUser" class="nav-btn active flex-1 py-3 text-sm font-medium">Employee Login</button>
      <button id="navAdmin" class="nav-btn flex-1 py-3 text-sm font-medium border-l">Admin Access</button>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto pb-20">
    
    <div id="userLoginPage" class="page active p-4 md:p-8">
      <div class="max-w-sm mx-auto glass-card p-8 rounded-2xl shadow-xl border border-gray-100">
        <div class="text-center mb-6">
          <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          </div>
          <h2 class="text-2xl font-bold">Welcome Back</h2>
          <p class="text-slate-500 text-sm">Enter your credentials to access your pass</p>
        </div>
        <div class="space-y-4">
          <input id="userCode" class="w-full px-4 py-3 rounded-xl bg-gray-50 focus:bg-white" placeholder="Employee Code" />
          <input id="userPass" class="w-full px-4 py-3 rounded-xl bg-gray-50 focus:bg-white" placeholder="Password" type="password" />
          <button id="btnUserLogin" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">Login to Dashboard</button>
          <p id="userLoginMsg" class="text-center text-sm text-red-600 font-medium"></p>
        </div>
      </div>
    </div>

    <div id="adminLoginPage" class="page p-4 md:p-8">
      <div class="max-w-sm mx-auto glass-card p-8 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
          Admin Login
        </h2>
        <div class="space-y-4">
          <input id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-gray-50" placeholder="Admin Email" type="email" />
          <input id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-gray-50" placeholder="Password" type="password" />
          <button id="btnAdminLogin" class="bg-slate-800 hover:bg-slate-900 text-white w-full py-3 rounded-xl font-bold transition-all">Sign In</button>
          <p id="adminLoginMsg" class="text-sm text-red-600 font-medium"></p>
        </div>
      </div>
    </div>

    <div id="adminPanel" class="page p-4 md:p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
        <button id="btnSignOut" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg font-semibold text-sm transition-colors border border-red-100">Sign Out</button>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          Quick Add Employee
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <input id="empCode" placeholder="Emp Code" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" />
          <input id="empName" placeholder="Full Name" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" />
          <input id="empDept" placeholder="Department" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" />
          <input id="empRoute" placeholder="Bus Route" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" />
          <input id="empStop" placeholder="Bus Stop" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" />
          <input id="empPassword" placeholder="Login Password" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white" type="password" />
          <input id="empLink" placeholder="Pass URL (Optional)" class="px-4 py-2 rounded-lg bg-slate-50 border-transparent focus:bg-white md:col-span-3" />
        </div>
        <div class="flex flex-wrap gap-2 mt-4">
          <button id="saveBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">Save Employee</button>
          <button id="clearBtn" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">Clear</button>
          <button id="refreshBtn" class="bg-green-100 text-green-700 px-6 py-2 rounded-lg font-bold hover:bg-green-200">Refresh List</button>
        </div>
        <p id="saveMsg" class="text-sm text-green-600 mt-2 font-medium"></p>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
        <h3 class="font-bold text-slate-700 mb-2">Bulk Excel Upload</h3>
        <div class="flex flex-col md:flex-row gap-3 items-center">
          <input type="file" id="excelFile" accept=".xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
          <button id="uploadExcelBtn" class="w-full md:w-auto bg-purple-600 text-white px-6 py-2 rounded-lg font-bold">Process File</button>
        </div>
        <div id="excelStatus" class="mt-2 text-xs text-slate-500 font-mono italic"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-4 bg-slate-50 border-b flex gap-2">
          <input id="adminSearch" type="text" placeholder="Search by name or code..." class="flex-1 px-4 py-2 rounded-lg border-slate-200 shadow-sm" />
          <button id="searchBtn" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-medium">Search</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
              <tr>
                <th class="p-4">Employee</th>
                <th class="p-4">Route/Stop</th>
                <th class="p-4">Dept</th>
                <th class="p-4">Pass</th>
                <th class="p-4">Action</th>
              </tr>
            </thead>
            <tbody id="empTableBody" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="userDashboard" class="page p-4 md:p-8">
      <div class="max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-slate-800">Your Identity Pass</h2>
          <button id="userLogoutBtn" class="text-red-600 font-semibold text-sm hover:underline">Logout</button>
        </div>

        <div id="passCard" class="pass-border shadow-2xl rounded-sm">
          <img src="Bajaj.png.png" class="w-20" alt="logo" />
          <div class="text-center font-bold text-lg mb-0.2">BAL CH-1</div>
          <div class="text-center font-bold text-lg mb-1">BUS PASS</div>
          <div style="font-size:13px;line-height:1.6">
            <div><span class="pass-label">Name:-</span> <span id="ticketName" class="pass-value"></span></div>
            <div><span class="pass-label">Ticket Number:</span> <span id="ticketCode" class="pass-value"></span></div>
            <div><span class="pass-label">Dept:</span> <span id="ticketDept" class="pass-value"></span></div>
            <div><span class="pass-label">Bus Route:-</span> <span id="ticketRoute" class="pass-value"></span></div>
            <div><span class="pass-label">Stop:-</span> <span id="ticketStop" class="pass-value"></span></div>
            <div><span class="pass-label">Date of Issue:-</span> <span id="ticketDate" class="pass-value"></span></div>
            <div><span class="pass-label">Emergency Gate Contact :-</span> <span id="ticketEmergency" class="pass-value">02135667051</span></div>
             <div style="display:flex; justify-content:flex-end; margin-top:8px;">
              <img src="sign.png.jpg" alt="signature" style="width:95px; opacity:0.95; object-fit:contain" />
            </div>
          </div>
        </div>

        <div class="mt-8 flex flex-col gap-3">
          <button id="downloadPassBtn" class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Download Digital Pass
          </button>
          <a id="officialPassImageLink" class="hidden text-center text-blue-600 font-medium py-2" target="_blank" href="#">View High-Res Version</a>
        </div>
      </div>
    </div>

  </main>

  <script type="module">
    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyA6xbGUg8A97-Bvs7yK7SOs9WMASeShmVA",
      authDomain: "nothing2-ccfdc.firebaseapp.com",
      databaseURL: "https://nothing2-ccfdc-default-rtdb.firebaseio.com",
      projectId: "nothing2-ccfdc",
      storageBucket: "nothing2-ccfdc.firebasestorage.app",
      messagingSenderId: "26795199212",
      appId: "1:26795199212:web:35389834d4c44a018533c9",
      measurementId: "G-N0DYPHNNSL"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, remove, get, onValue, off, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const pages = {
      userLogin: document.getElementById("userLoginPage"),
      adminLogin: document.getElementById("adminLoginPage"),
      adminPanel: document.getElementById("adminPanel"),
      userDashboard: document.getElementById("userDashboard")
    };
    
    function showPageKey(k){ 
      Object.values(pages).forEach(el => el.classList.remove("active")); 
      pages[k].classList.add("active"); 
      
      // Update Navigation styling
      document.getElementById("navUser").classList.remove("active");
      document.getElementById("navAdmin").classList.remove("active");
      if(k === 'userLogin' || k === 'userDashboard') document.getElementById("navUser").classList.add("active");
      if(k === 'adminLogin' || k === 'adminPanel') document.getElementById("navAdmin").classList.add("active");
      
      window.scrollTo({top:0,behavior:'smooth'}); 
    }

    document.getElementById("navUser").addEventListener("click",()=>showPageKey("userLogin"));
    document.getElementById("navAdmin").addEventListener("click",()=>showPageKey("adminLogin"));

    // ---------------- Admin Auth ----------------
    const adminEmailEl = document.getElementById("adminEmail");
    const adminPasswordEl = document.getElementById("adminPassword");
    const adminLoginMsg = document.getElementById("adminLoginMsg");
    const btnAdminLogin = document.getElementById("btnAdminLogin");
    const btnSignOut = document.getElementById("btnSignOut");

    btnAdminLogin.addEventListener("click", async () => {
      adminLoginMsg.innerText="";
      const email = adminEmailEl.value.trim();
      const pass = adminPasswordEl.value.trim();
      if(!email || !pass){ adminLoginMsg.innerText="Enter email and password"; return; }
      try {
        await signInWithEmailAndPassword(auth,email,pass);
        adminEmailEl.value=""; adminPasswordEl.value="";
        showPageKey("adminPanel"); loadEmployeeTable();
      } catch(err){ console.error(err); adminLoginMsg.innerText="Login failed. Check credentials."; }
    });

    btnSignOut.addEventListener("click", async () => { await signOut(auth).catch(()=>{}); showPageKey("adminLogin"); });

    // ---------------- Employee CRUD ----------------
    const empCodeEl = document.getElementById("empCode");
    const empNameEl = document.getElementById("empName");
    const empDeptEl = document.getElementById("empDept");
    const empRouteEl = document.getElementById("empRoute");
    const empStopEl = document.getElementById("empStop");
    const empPasswordEl = document.getElementById("empPassword");
    const empLinkEl = document.getElementById("empLink");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const saveMsg = document.getElementById("saveMsg");

    saveBtn.addEventListener("click", async () => {
      const code = empCodeEl.value.trim();
      const name = empNameEl.value.trim();
      const dept = empDeptEl.value.trim();
      const route = empRouteEl.value.trim();
      const stop = empStopEl.value.trim();
      const pass = empPasswordEl.value.trim();
      const link = empLinkEl.value.trim();

      if(!code) return alert("Employee Code required");
      if(!name) return alert("Employee Name required");
      if(!pass) return alert("Employee Password required");

      const payload = { code, name, dept, route, stop, password: pass.toString().trim(), link: link || "" };
      await set(ref(db,"employees/"+code),payload).catch(err=>alert("Save failed: "+err.message));
      saveMsg.innerText="âœ“ Successfully Saved!";
      setTimeout(() => saveMsg.innerText="", 3000);
      clearForm(); loadEmployeeTable();
    });

    clearBtn.addEventListener("click", clearForm);
    refreshBtn.addEventListener("click", loadEmployeeTable);
    function clearForm(){ empCodeEl.value=""; empNameEl.value=""; empDeptEl.value=""; empRouteEl.value=""; empStopEl.value=""; empPasswordEl.value=""; empLinkEl.value=""; }

    // ---------------- Load Employee Table ----------------
    const empTableBody = document.getElementById("empTableBody");
    function loadEmployeeTable(){
      const empRef = ref(db,"employees"); off(empRef);
      empTableBody.innerHTML="<tr><td colspan='5' class='text-center p-8 text-slate-400'>Loading database...</td></tr>";
      onValue(empRef, snapshot=>{
        empTableBody.innerHTML="";
        if(!snapshot.exists()){ empTableBody.innerHTML="<tr><td colspan='5' class='text-center p-8'>No records found</td></tr>"; return; }
        snapshot.forEach(childSnap=>{
          const e=childSnap.val();
          const tr=document.createElement("tr");
          tr.className="hover:bg-slate-50 transition-colors";
          tr.innerHTML=`
            <td class="p-4">
              <div class="font-bold text-slate-800 empCode">${escapeHtml(e.code)}</div>
              <div class="text-xs text-slate-500 empName">${escapeHtml(e.name)}</div>
            </td>
            <td class="p-4 text-sm">
              <div class="font-medium">${escapeHtml(e.route||"N/A")}</div>
              <div class="text-xs text-slate-400">${escapeHtml(e.stop||"-")}</div>
            </td>
            <td class="p-4 text-sm text-slate-600">${escapeHtml(e.dept||"")}</td>
            <td class="p-4">${e.link?`<a href="${escapeAttr(e.link)}" target="_blank" class="text-blue-500 text-xs font-bold underline">VIEW</a>`:"-"}</td>
            <td class="p-4">
              <button class="text-red-500 hover:text-red-700 font-bold text-xs" data-code="${encodeURIComponent(e.code)}" data-action="delete">DELETE</button>
            </td>
          `;
          empTableBody.appendChild(tr);
        });
        empTableBody.querySelectorAll("button[data-action='delete']").forEach(btn=>{
          btn.onclick=()=>{
            const code=decodeURIComponent(btn.getAttribute("data-code"));
            if(!confirm("Are you sure you want to delete "+code+"?")) return;
            remove(ref(db,"employees/"+code));
          };
        });
      });
    }

    // ---------------- User login ----------------
    const userCodeEl = document.getElementById("userCode");
    const userPassEl = document.getElementById("userPass");
    const userLoginMsg = document.getElementById("userLoginMsg");

    document.getElementById("btnUserLogin").addEventListener("click", async()=>{
      userLoginMsg.innerText="";
      const code=userCodeEl.value.trim();
      const pass=userPassEl.value.trim();
      if(!code||!pass){ userLoginMsg.innerText="Required: Code & Password"; return; }

      try{
        const snap=await get(child(ref(db),"employees/"+code));
        if(!snap.exists()){ userLoginMsg.innerText="Employee not found"; return; }
        const e=snap.val();
        if(e.password.toString().trim() !== pass){ userLoginMsg.innerText="Invalid password"; return; }

        document.getElementById("ticketName").innerText=e.name||"";
        document.getElementById("ticketCode").innerText=e.code||"";
        document.getElementById("ticketDept").innerText=e.dept||"";
        document.getElementById("ticketRoute").innerText=e.route||"";
        document.getElementById("ticketStop").innerText=e.stop||"";
        const today=new Date();
        document.getElementById("ticketDate").innerText=`${pad(today.getDate())}-${pad(today.getMonth()+1)}-${today.getFullYear()}`;

        const dashLinkEl=document.getElementById("officialPassImageLink");
        if(e.link){ dashLinkEl.href=e.link; dashLinkEl.classList.remove("hidden"); } else { dashLinkEl.classList.add("hidden"); }

        userCodeEl.value=""; userPassEl.value="";
        showPageKey("userDashboard");
      }catch(err){ userLoginMsg.innerText="Network error"; }
    });

    document.getElementById("userLogoutBtn").addEventListener("click",()=>showPageKey("userLogin"));

    // ---------------- Download pass ----------------
    document.getElementById("downloadPassBtn").addEventListener("click",()=>{
      const node=document.getElementById("passCard");
      html2canvas(node,{scale:3, backgroundColor: null}).then(canvas=>{
        const link=document.createElement("a");
        link.download=`Pass_${document.getElementById("ticketCode").innerText}.png`;
        link.href=canvas.toDataURL("image/png");
        link.click();
      });
    });

    // ---------------- Excel bulk upload ----------------
    const excelStatus = document.getElementById("excelStatus");
    document.getElementById("uploadExcelBtn").addEventListener("click", async()=>{
      const file = document.getElementById("excelFile").files[0];
      if(!file) return alert("Select file");
      excelStatus.innerText="Processing...";
      const reader=new FileReader();
      reader.onload=async(e)=>{
        try{
          const data=new Uint8Array(e.target.result);
          const workbook=XLSX.read(data,{type:"array"});
          const sheet=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]],{defval:""});
          let success=0;
          for(let row of sheet){
            const normalized={};
            Object.keys(row).forEach(k=>normalized[k.toString().trim().toLowerCase()]=row[k]);
            if(normalized.code && normalized.name){
              await set(ref(db,"employees/"+normalized.code), {
                code: normalized.code.toString(),
                name: normalized.name,
                dept: normalized.dept || "",
                route: normalized.route || "",
                stop: normalized.stop || "",
                password: (normalized.password || "123").toString(),
                link: normalized.link || ""
              });
              success++;
            }
          }
          excelStatus.innerText=`Done! Uploaded ${success} records.`;
          loadEmployeeTable();
        } catch(err) { excelStatus.innerText="Error processing file"; }
      };
      reader.readAsArrayBuffer(file);
    });

    // ---------------- Search Logic ----------------
    document.getElementById("searchBtn").addEventListener("click", ()=>{
      const q = document.getElementById("adminSearch").value.toLowerCase();
      document.querySelectorAll("#empTableBody tr").forEach(row=>{
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? "" : "none";
      });
    });

    // Helpers
    function pad(n){ return n<10?"0"+n:n; }
    function escapeHtml(s){ if(!s) return ""; return s.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;"); }
    function escapeAttr(s){ if(!s) return ""; return s.toString().replace(/"/g,"&quot;"); }

    onAuthStateChanged(auth,user=>{ if(user){ showPageKey("adminPanel"); loadEmployeeTable(); } });
  </script>
</body>
</html>
