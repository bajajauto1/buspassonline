<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Online Bus Pass System - Single File (Firebase Auth)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas to capture pass as PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- XLSX Library for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    .page { display: none; }
    .page.active { display: block; }
    .pass-label { font-weight: 600; }
    .pass-value { margin-left: 6px; }
    .pass-border { border: 3px dotted #000; padding: 10px; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- HEADER -->
  <div class="bg-blue-700 text-white p-4 text-center text-xl font-bold">
    BAJAJ AUTO CHAKAN - 1 BUS PASS DOWNLOAD
  </div>

  <!-- NAV SWITCH -->
  <div class="flex justify-center gap-4 p-4">
    <button id="navUser" class="bg-gray-800 text-white px-4 py-2 rounded">User Login</button>
    <button id="navAdmin" class="bg-blue-700 text-white px-4 py-2 rounded">Admin Login</button>
  </div>

  <!-- ========== USER LOGIN PAGE ========== -->
  <div id="userLoginPage" class="page active p-6">
    <div class="max-w-md mx-auto bg-white p-6 shadow rounded">
      <h2 class="text-lg font-bold mb-3">Employee Login</h2>
      <input id="userCode" class="border p-2 w-full mb-3" placeholder="Employee Code" />
      <input id="userPass" class="border p-2 w-full mb-3" placeholder="Password" type="password" />
      <button id="btnUserLogin" class="bg-blue-600 text-white w-full py-2 rounded">Login</button>
      <p id="userLoginMsg" class="text-sm text-red-600 mt-2"></p>
    </div>
  </div>

  <!-- ========== ADMIN LOGIN PAGE (Firebase Email+Password) ========== -->
  <div id="adminLoginPage" class="page p-6">
    <div class="max-w-md mx-auto bg-white p-6 shadow rounded">
      <h2 class="text-lg font-bold mb-3">Admin Login (Firebase Auth)</h2>
      <input id="adminEmail" class="border p-2 w-full mb-3" placeholder="Admin email" type="email" />
      <input id="adminPassword" class="border p-2 w-full mb-3" placeholder="Password" type="password" />
      <button id="btnAdminLogin" class="bg-green-600 text-white w-full py-2 rounded">Sign in</button>
      <p id="adminLoginMsg" class="text-sm text-red-600 mt-2"></p>
      <p class="text-sm text-gray-600 mt-3">Create the admin account in Firebase Console → Authentication → Add user.</p>
    </div>
  </div>

  <!-- ========== ADMIN PANEL ========== -->
  <div id="adminPanel" class="page p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Admin Dashboard</h2>
      <div class="flex gap-2">
        <button id="btnSignOut" class="bg-red-600 text-white px-3 py-2 rounded">Sign out</button>
      </div>
    </div>

    <div class="bg-white p-5 rounded shadow mb-6">
      <h3 class="text-lg font-bold mb-3">Add Employee</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="empCode" placeholder="Employee Code" class="border p-2" />
        <input id="empName" placeholder="Employee Name" class="border p-2" />
        <input id="empDept" placeholder="Department" class="border p-2" />
        <input id="empRoute" placeholder="Bus Route" class="border p-2" />
        <input id="empStop" placeholder="Bus Stop" class="border p-2" />
        <input id="empPassword" placeholder="Password (for employee login)" class="border p-2" type="password" />
        <input id="empLink" placeholder="Optional: Pass Image/Download Link (public URL)" class="border p-2 md:col-span-2" />
      </div>
      <div class="mt-3">
        <button id="saveBtn" class="bg-blue-700 text-white px-4 py-2 rounded">Save</button>
        <button id="clearBtn" class="ml-2 bg-gray-400 text-white px-4 py-2 rounded">Clear</button>
        <button id="refreshBtn" class="ml-2 bg-green-500 text-white px-4 py-2 rounded">Refresh Table</button>
      </div>
      <p id="saveMsg" class="text-sm text-green-700 mt-2"></p>
    </div>

    <!-- ========== BULK EXCEL UPLOAD ========== -->
    <div class="bg-white p-5 rounded shadow mb-6">
      <h3 class="text-lg font-bold mb-3">Bulk Upload (Excel)</h3>
      <p class="text-sm mb-3 text-gray-700">
        Upload .xlsx file containing columns (case-insensitive): <b>code, name, dept, route, stop, password, link</b>
      </p>

      <input type="file" id="excelFile" accept=".xlsx" class="border p-2 w-full mb-3" />
      <button id="uploadExcelBtn" class="bg-purple-700 text-white px-4 py-2 rounded">Upload Excel File</button>
      <div id="excelStatus" class="mt-3 text-sm text-green-700 font-bold"></div>
    </div>

    <div class="bg-white p-5 rounded shadow">
      <h3 class="text-lg font-bold mb-3">All Employees</h3>
      <div class="overflow-x-auto">
        <table class="w-full border">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2">Code</th>
              <th class="p-2">Name</th>
              <th class="p-2">Dept</th>
              <th class="p-2">Route</th>
              <th class="p-2">Stop</th>
              <th class="p-2">Pass Link</th>
              <th class="p-2">Action</th>
            </tr>
          </thead>
          <tbody id="empTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  

     <!-- ========== USER DASHBOARD / PASS ========== -->
  <div id="userDashboard" class="page p-6">
    <div class="max-w-md mx-auto bg-white p-6 shadow rounded">
      <div class="flex justify-between items-center mb-4">
        
        <h2 class="text-lg font-bold">Your Bus Pass</h2>
        <button id="userLogoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
      </div>

      <!-- PASS CARD -->
      <div id="passCard" class="pass-border bg-white">
        <img src="Bajaj.png.png" class="w-20" alt="logo" />
        <div class="text-center font-bold text-lg mb-0.2">BAL CH-1</div>
        <div class="text-center font-bold text-lg mb-1">BUS PASS</div>
        <div style="font-size:13px;line-height:1.6">
          <div><span class="pass-label">Name:-</span> <span id="ticketName" class="pass-value"></span></div>
          <div><span class="pass-label">Ticket Number:</span> <span id="ticketCode" class="pass-value"></span></div>
          <div><span class="pass-label">Dept:</span> <span id="ticketDept" class="pass-value"></span></div>
          <div><span class="pass-label">Bus Route:-</span> <span id="ticketRoute" class="pass-value"></span></div>
          <div><span class="pass-label">Stop:-</span> <span id="ticketStop" class="pass-value"></span></div>
          <div><span class="pass-label">Date of Issue:-</span> <span id="ticketDate" class="pass-value"></span></div>
          <div><span class="pass-label">Emergency Gate Contact :-</span> <span id="ticketEmergency" class="pass-value">02135667051</span></div>
           <div style="display:flex; justify-content:flex-end; margin-top:8px;">
            <!-- Developer requested uploaded file path used here as signature/sample -->
            <img src="sign.png.jpg" alt="signature" style="width:95px; opacity:0.95; object-fit:contain" />
          </div>
        </div>
        </div>
          
      </div>
      

      <div class="mt-4 flex gap-2">
        <button id="downloadPassBtn" class="bg-blue-700 text-white px-4 py-2 rounded w-full">Download Pass (PNG)</button>
        <a id="officialPassImageLink" class="hidden bg-gray-700 text-white px-4 py-2 rounded inline-flex items-center" target="_blank" href="#">Open Original</a>
        
          </div>
      </div>
    </div>
  </div>

  <!-- ================= JS ================= -->
  <script type="module">
    const firebaseConfig = {
          apiKey: "AIzaSyA6xbGUg8A97-Bvs7yK7SOs9WMASeShmVA",
  authDomain: "nothing2-ccfdc.firebaseapp.com",
  databaseURL: "https://nothing2-ccfdc-default-rtdb.firebaseio.com",
  projectId: "nothing2-ccfdc",
  storageBucket: "nothing2-ccfdc.firebasestorage.app",
  messagingSenderId: "26795199212",
  appId: "1:26795199212:web:35389834d4c44a018533c9",
  measurementId: "G-N0DYPHNNSL"
      // <-- PASTE YOUR FIREBASE CONFIG OBJECT HERE
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, remove, get, onValue, off, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const pages = {
      userLogin: document.getElementById("userLoginPage"),
      adminLogin: document.getElementById("adminLoginPage"),
      adminPanel: document.getElementById("adminPanel"),
      userDashboard: document.getElementById("userDashboard")
    };
    function showPageKey(k){ Object.values(pages).forEach(el => el.classList.remove("active")); pages[k].classList.add("active"); window.scrollTo({top:0,behavior:'smooth'}); }

    document.getElementById("navUser").addEventListener("click",()=>showPageKey("userLogin"));
    document.getElementById("navAdmin").addEventListener("click",()=>showPageKey("adminLogin"));

    showPageKey("userLogin");

    // ---------------- Admin Auth ----------------
    const adminEmailEl = document.getElementById("adminEmail");
    const adminPasswordEl = document.getElementById("adminPassword");
    const adminLoginMsg = document.getElementById("adminLoginMsg");
    const btnAdminLogin = document.getElementById("btnAdminLogin");
    const btnSignOut = document.getElementById("btnSignOut");

    btnAdminLogin.addEventListener("click", async () => {
      adminLoginMsg.innerText="";
      const email = adminEmailEl.value.trim();
      const pass = adminPasswordEl.value.trim();
      if(!email || !pass){ adminLoginMsg.innerText="Enter email and password"; return; }
      try {
        await signInWithEmailAndPassword(auth,email,pass);
        adminEmailEl.value=""; adminPasswordEl.value="";
        showPageKey("adminPanel"); loadEmployeeTable();
      } catch(err){ console.error(err); adminLoginMsg.innerText="Login failed. Check credentials."; }
    });

    btnSignOut.addEventListener("click", async () => { await signOut(auth).catch(()=>{}); showPageKey("adminLogin"); });

    // ---------------- Employee CRUD ----------------
    const empCodeEl = document.getElementById("empCode");
    const empNameEl = document.getElementById("empName");
    const empDeptEl = document.getElementById("empDept");
    const empRouteEl = document.getElementById("empRoute");
    const empStopEl = document.getElementById("empStop");
    const empPasswordEl = document.getElementById("empPassword");
    const empLinkEl = document.getElementById("empLink");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const saveMsg = document.getElementById("saveMsg");

    saveBtn.addEventListener("click", async () => {
      const code = empCodeEl.value.trim();
      const name = empNameEl.value.trim();
      const dept = empDeptEl.value.trim();
      const route = empRouteEl.value.trim();
      const stop = empStopEl.value.trim();
      const pass = empPasswordEl.value.trim();
      const link = empLinkEl.value.trim();

      if(!code) return alert("Employee Code required");
      if(!name) return alert("Employee Name required");
      if(!pass) return alert("Employee Password required (for user login)");

      const payload = { code, name, dept, route, stop, password: pass.toString().trim(), link: link || "" };
      await set(ref(db,"employees/"+code),payload).catch(err=>alert("Save failed: "+err.message));
      saveMsg.innerText="Saved!";
      clearForm(); loadEmployeeTable();
    });

    clearBtn.addEventListener("click", clearForm);
    refreshBtn.addEventListener("click", loadEmployeeTable);

    function clearForm(){ empCodeEl.value=""; empNameEl.value=""; empDeptEl.value=""; empRouteEl.value=""; empStopEl.value=""; empPasswordEl.value=""; empLinkEl.value=""; saveMsg.innerText=""; }

    // ---------------- Load Employee Table ----------------
    const empTableBody = document.getElementById("empTableBody");
    function loadEmployeeTable(){
      const empRef = ref(db,"employees"); off(empRef);
      empTableBody.innerHTML="<tr><td colspan='7' class='text-center p-4'>Loading...</td></tr>";
      onValue(empRef, snapshot=>{
        empTableBody.innerHTML="";
        if(!snapshot.exists()){ empTableBody.innerHTML="<tr><td colspan='7' class='text-center p-4'>No employees found</td></tr>"; return; }
        snapshot.forEach(childSnap=>{
          const e=childSnap.val();
          const tr=document.createElement("tr");
          tr.className="border-b";
          tr.innerHTML=`
            <td class="p-2">${escapeHtml(e.code)}</td>
            <td class="p-2">${escapeHtml(e.name)}</td>
            <td class="p-2">${escapeHtml(e.dept||"")}</td>
            <td class="p-2">${escapeHtml(e.route||"")}</td>
            <td class="p-2">${escapeHtml(e.stop||"")}</td>
            <td class="p-2">${e.link?`<a href="${escapeAttr(e.link)}" target="_blank" class="text-blue-600">Link</a>`:"-"}</td>
            <td class="p-2">
              <button class="bg-red-600 text-white px-2 py-1 rounded" data-code="${encodeURIComponent(e.code)}" data-action="delete">Delete</button>
            </td>
          `;
          empTableBody.appendChild(tr);
        });
        empTableBody.querySelectorAll("button[data-action='delete']").forEach(btn=>{
          btn.onclick=()=>{
            const code=decodeURIComponent(btn.getAttribute("data-code"));
            if(!confirm("Delete employee "+code+" ?")) return;
            remove(ref(db,"employees/"+code)).catch(err=>alert("Delete failed: "+err.message));
          };
        });
      });
    }

    // ---------------- User login ----------------
    const userCodeEl = document.getElementById("userCode");
    const userPassEl = document.getElementById("userPass");
    const userLoginMsg = document.getElementById("userLoginMsg");
    const userLogoutBtn = document.getElementById("userLogoutBtn");

    document.getElementById("btnUserLogin").addEventListener("click", async()=>{
      userLoginMsg.innerText="";
      const code=userCodeEl.value.trim();
      const pass=userPassEl.value.trim();
      if(!code||!pass){ userLoginMsg.innerText="Enter code & password"; return; }

      try{
        const snap=await get(child(ref(db),"employees/"+code));
        if(!snap.exists()){ userLoginMsg.innerText="Employee not found"; return; }
        const e=snap.val();
        const storedPass=(e.password||"").toString().trim();
        const enteredPass=pass.trim();
        if(!storedPass || storedPass!==enteredPass){ userLoginMsg.innerText="Invalid password"; return; }

        document.getElementById("ticketName").innerText=e.name||"";
        document.getElementById("ticketCode").innerText=e.code||"";
        document.getElementById("ticketDept").innerText=e.dept||"";
        document.getElementById("ticketRoute").innerText=e.route||"";
        document.getElementById("ticketStop").innerText=e.stop||"";
        const today=new Date();
        document.getElementById("ticketDate").innerText=`${pad(today.getDate())}-${pad(today.getMonth()+1)}-${today.getFullYear()}`;

        const dashLinkEl=document.getElementById("officialPassImageLink");
        if(e.link){ dashLinkEl.href=e.link; dashLinkEl.classList.remove("hidden"); } else { dashLinkEl.classList.add("hidden"); }

        userCodeEl.value=""; userPassEl.value="";
        showPageKey("userDashboard");
      }catch(err){ console.error(err); userLoginMsg.innerText="Login failed"; }
    });

    userLogoutBtn.addEventListener("click",()=>{ showPageKey("userLogin"); });

    // ---------------- Download pass ----------------
    document.getElementById("downloadPassBtn").addEventListener("click",()=>{
      const node=document.getElementById("passCard");
      html2canvas(node,{scale:2}).then(canvas=>{
        const link=document.createElement("a");
        link.download=`${document.getElementById("ticketCode").innerText||"buspass"}.png`;
        link.href=canvas.toDataURL("image/png");
        link.click();
      }).catch(err=>alert("Download failed: "+err));
    });

    // ---------------- Excel bulk upload ----------------
    const uploadExcelBtn = document.getElementById("uploadExcelBtn");
    const excelStatus = document.getElementById("excelStatus");
    uploadExcelBtn.addEventListener("click", async()=>{
      const fileInput=document.getElementById("excelFile");
      const file=fileInput.files[0];
      if(!file) return alert("Please select an Excel (.xlsx) file");
      excelStatus.innerText="Reading file...";
      const reader=new FileReader();
      reader.onload=async(e)=>{
        try{
          const data=new Uint8Array(e.target.result);
          const workbook=XLSX.read(data,{type:"array"});
          const sheetName=workbook.SheetNames[0];
          const sheet=XLSX.utils.sheet_to_json(workbook.Sheets[sheetName],{defval:""});
          if(!sheet.length){ excelStatus.innerText="Excel is empty"; return; }

          let success=0, failed=0;
          excelStatus.innerText=`Uploading ${sheet.length} rows...`;

          const promises=sheet.map(row=>{
            const normalized={};
            Object.keys(row).forEach(k=>normalized[k.toString().trim().toLowerCase()]=row[k]);
            const codeRaw=normalized.code;
            const name=normalized.name||"";
            const dept=normalized.dept||"";
            const route=normalized.route||"";
            const stop=normalized.stop||"";
            const password=(normalized.password||"").toString().trim();
            const link=normalized.link||"";
            if(!codeRaw || !name || !password){ failed++; return Promise.resolve(); }
            const code=codeRaw.toString().trim();
            const payload={ code,name,dept,route,stop,password,link };
            return set(ref(db,"employees/"+code),payload).then(()=>{ success++; }).catch(err=>{ console.error("Upload error",err); failed++; });
          });
          await Promise.all(promises);
          excelStatus.innerText=`Uploaded: ${success} | Failed: ${failed}`;
          loadEmployeeTable();
        }catch(err){ console.error(err); excelStatus.innerText="Failed to parse Excel file: "+err.message; }
      };
      reader.readAsArrayBuffer(file);
    });

    function pad(n){ return n<10?"0"+n:n; }
    function escapeHtml(s){ if(s===undefined||s===null) return ""; return s.toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function escapeAttr(s){ if(!s) return ""; return s.toString().replaceAll('"','&quot;'); }

    onAuthStateChanged(auth,user=>{ if(user){ showPageKey("adminPanel"); loadEmployeeTable(); } });
  </script>
</body>
</html>

